#cloud-config
# ResearchRadar — Oracle Cloud A1 ARM VM auto-setup
# Installs Docker, Nginx, Certbot, builds and runs the app.

package_update: true
package_upgrade: true

packages:
  - docker-ce
  - docker-ce-cli
  - containerd.io
  - docker-compose-plugin
  - nginx
  - certbot
  - python3-certbot-nginx
  - git
  - firewalld

runcmd:
  # ── Firewall ─────────────────────────────────────────────────────
  - systemctl enable --now firewalld
  - firewall-cmd --permanent --add-service=http
  - firewall-cmd --permanent --add-service=https
  - firewall-cmd --permanent --add-service=ssh
  - firewall-cmd --reload

  # ── Docker ───────────────────────────────────────────────────────
  - systemctl enable --now docker
  - usermod -aG docker opc

  # ── Clone and build ──────────────────────────────────────────────
  - mkdir -p /opt/researchradar
  - git clone https://github.com/arkgithubforyou/researchradar.git /opt/researchradar
  - cd /opt/researchradar

  # Create .env file
  - |
    cat > /opt/researchradar/.env << 'ENVEOF'
    LLM_BACKEND=groq
    GROQ_API_KEY=${groq_api_key}
    SQLITE_DB_PATH=/app/data/researchradar.db
    CHROMA_DB_PATH=/app/data/chroma_db
    ENVEOF

  # Build Docker image (ARM64 native on A1)
  - cd /opt/researchradar && docker build -t researchradar:latest .

  # Run the container
  - |
    docker run -d \
      --name researchradar \
      --restart unless-stopped \
      -p 127.0.0.1:8000:8000 \
      --env-file /opt/researchradar/.env \
      -v researchradar-data:/app/data \
      -v researchradar-cache:/app/.cache/huggingface \
      researchradar:latest

  # ── Nginx reverse proxy ──────────────────────────────────────────
  - |
    cat > /etc/nginx/conf.d/researchradar.conf << 'NGINXEOF'
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;

        client_max_body_size 10M;

        location / {
            proxy_pass http://127.0.0.1:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Longer timeout for RAG queries (LLM can be slow)
            proxy_read_timeout 120s;
            proxy_send_timeout 120s;
        }
    }
    NGINXEOF

  # Remove default nginx config that conflicts
  - rm -f /etc/nginx/conf.d/default.conf
  - nginx -t && systemctl enable --now nginx

  # ── Optional: Let's Encrypt TLS (if domain is set) ──────────────
  - |
    DOMAIN="${domain_name}"
    if [ -n "$DOMAIN" ] && [ "$DOMAIN" != "" ]; then
      # Update nginx server_name
      sed -i "s/server_name _;/server_name $DOMAIN;/" /etc/nginx/conf.d/researchradar.conf
      nginx -t && systemctl reload nginx
      # Get cert (non-interactive)
      certbot --nginx -d "$DOMAIN" --non-interactive --agree-tos \
        --email admin@"$DOMAIN" --redirect
    fi

  # ── Deploy helper script ─────────────────────────────────────────
  - |
    cat > /opt/researchradar/redeploy.sh << 'DEPLOYEOF'
    #!/bin/bash
    set -e
    cd /opt/researchradar
    echo "Pulling latest code..."
    git pull origin master
    echo "Building new image..."
    docker build -t researchradar:latest .
    echo "Restarting container..."
    docker stop researchradar 2>/dev/null || true
    docker rm researchradar 2>/dev/null || true
    docker run -d \
      --name researchradar \
      --restart unless-stopped \
      -p 127.0.0.1:8000:8000 \
      --env-file /opt/researchradar/.env \
      -v researchradar-data:/app/data \
      -v researchradar-cache:/app/.cache/huggingface \
      researchradar:latest
    echo "Done! Cleaning old images..."
    docker image prune -f
    DEPLOYEOF
    chmod +x /opt/researchradar/redeploy.sh

  # ── Certbot auto-renewal cron ────────────────────────────────────
  - echo "0 3 * * * root certbot renew --quiet" > /etc/cron.d/certbot-renew
