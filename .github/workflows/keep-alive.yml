name: Keep HF Space Alive

# Ping the Hugging Face Space every 12 hours to prevent 48h sleep.
# The Space URL is stored as a repository variable (not secret — it's public).

on:
  schedule:
    # Every 12 hours: at 06:00 and 18:00 UTC
    - cron: "0 6,18 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping HF Space health endpoint
        env:
          SPACE_URL: ${{ vars.HF_SPACE_URL }}
        run: |
          if [ -z "$SPACE_URL" ]; then
            echo "HF_SPACE_URL variable not set — skipping"
            exit 0
          fi

          echo "Pinging $SPACE_URL/api/health ..."

          # First request may wake the Space (takes up to 2 min)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --max-time 180 \
            "$SPACE_URL/api/health")

          echo "Response: HTTP $HTTP_CODE"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "Space is alive!"
          else
            echo "Space returned $HTTP_CODE — it may be starting up"
            # Retry after 60 seconds (Space may still be booting)
            sleep 60
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --max-time 180 \
              "$SPACE_URL/api/health")
            echo "Retry response: HTTP $HTTP_CODE"
          fi
